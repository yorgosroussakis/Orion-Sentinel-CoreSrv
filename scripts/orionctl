#!/usr/bin/env bash
# orionctl - Orion-Sentinel-CoreSrv modular control script
#
# This script manages the modular Docker Compose architecture.
# Each module (media, gateway, observability, homeauto) can be
# started and stopped independently.
#
# Usage:
#   ./scripts/orionctl up media       # Start media module
#   ./scripts/orionctl down media     # Stop media module
#   ./scripts/orionctl status         # Show all module status
#   ./scripts/orionctl help           # Show help

set -euo pipefail

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory - resolve symlinks to find the real script location
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_SOURCE" ]; do
    LINK_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$LINK_DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

# Change to repo root
cd "$REPO_ROOT"

# Compose directory
COMPOSE_DIR="$REPO_ROOT/compose"
ENV_DIR="$REPO_ROOT/env"

# Helper functions
info() {
    echo -e "${BLUE}ℹ${NC} $*"
}

success() {
    echo -e "${GREEN}✓${NC} $*"
}

warn() {
    echo -e "${YELLOW}⚠${NC} $*"
}

error() {
    echo -e "${RED}✗${NC} $*"
    exit 1
}

# Check if env file exists
check_env_file() {
    local env_file="$1"
    if [ ! -f "$env_file" ]; then
        warn "Environment file not found: $env_file"
        warn "Copy the example file and customize it:"
        echo "  cp ${env_file}.example $env_file"
        echo "  vi $env_file"
        return 1
    fi
    return 0
}

# Check if compose file exists
check_compose_file() {
    local compose_file="$1"
    if [ ! -f "$compose_file" ]; then
        error "Compose file not found: $compose_file"
    fi
}

# Get env file for module
get_env_file() {
    local module="$1"
    case "$module" in
        media)
            echo "$ENV_DIR/.env.media"
            ;;
        gateway)
            echo "$ENV_DIR/.env.gateway"
            ;;
        observability)
            echo "$ENV_DIR/.env.observability"
            ;;
        homeauto)
            echo "$ENV_DIR/.env.homeauto"
            ;;
        *)
            error "Unknown module: $module"
            ;;
    esac
}

# Get compose file for module
get_compose_file() {
    local module="$1"
    case "$module" in
        media)
            echo "$COMPOSE_DIR/docker-compose.media.yml"
            ;;
        gateway)
            echo "$COMPOSE_DIR/docker-compose.gateway.yml"
            ;;
        observability)
            echo "$COMPOSE_DIR/docker-compose.observability.yml"
            ;;
        homeauto)
            echo "$COMPOSE_DIR/docker-compose.homeauto.yml"
            ;;
        *)
            error "Unknown module: $module"
            ;;
    esac
}

# Get default profile for module
get_default_profile() {
    local module="$1"
    case "$module" in
        media)
            echo "media-core"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Module up command
module_up() {
    local module="$1"
    local profile="${2:-}"
    
    local compose_file
    compose_file=$(get_compose_file "$module")
    check_compose_file "$compose_file"
    
    local env_file
    env_file=$(get_env_file "$module")
    
    # Build the docker compose command using array
    local -a cmd_args=("docker" "compose" "-f" "$compose_file")
    
    # Add env file if it exists
    if [ -f "$env_file" ]; then
        cmd_args+=("--env-file" "$env_file")
    else
        warn "No env file found at $env_file, using defaults"
    fi
    
    # Add profile if specified or use default
    if [ -z "$profile" ]; then
        profile=$(get_default_profile "$module")
    fi
    
    if [ -n "$profile" ]; then
        cmd_args+=("--profile" "$profile")
        info "Starting $module module with profile '$profile'..."
    else
        info "Starting $module module..."
    fi
    
    # Run the command with --remove-orphans to avoid warnings
    "${cmd_args[@]}" up -d --remove-orphans
    
    success "$module module started"
    
    # Show access info
    case "$module" in
        media)
            echo ""
            info "Access media services:"
            echo "  Jellyfin:    http://localhost:8096"
            echo "  qBittorrent: http://localhost:5080"
            echo "  Radarr:      http://localhost:7878"
            echo "  Sonarr:      http://localhost:8989"
            echo "  Prowlarr:    http://localhost:9696"
            echo "  Jellyseerr:  http://localhost:5055"
            ;;
        gateway)
            echo ""
            info "Access gateway services:"
            echo "  Traefik:  https://traefik.local"
            echo "  Authelia: https://auth.local"
            ;;
        observability)
            echo ""
            info "Access observability services:"
            echo "  Grafana:     https://grafana.local"
            echo "  Prometheus:  https://prometheus.local"
            echo "  Uptime Kuma: https://status.local"
            ;;
        homeauto)
            echo ""
            info "Access home automation services:"
            echo "  Home Assistant: https://ha.local"
            echo "  Zigbee2MQTT:    https://zigbee.local"
            echo "  Mealie:         https://mealie.local"
            ;;
    esac
}

# Module down command
module_down() {
    local module="$1"
    
    local compose_file
    compose_file=$(get_compose_file "$module")
    check_compose_file "$compose_file"
    
    local env_file
    env_file=$(get_env_file "$module")
    
    info "Stopping $module module..."
    
    local -a cmd_args=("docker" "compose" "-f" "$compose_file")
    if [ -f "$env_file" ]; then
        cmd_args+=("--env-file" "$env_file")
    fi
    
    "${cmd_args[@]}" down
    
    success "$module module stopped"
}

# Module status command
module_status() {
    local module="${1:-}"
    
    if [ -n "$module" ]; then
        local compose_file
        compose_file=$(get_compose_file "$module")
        check_compose_file "$compose_file"
        
        local env_file
        env_file=$(get_env_file "$module")
        
        info "Status for $module module:"
        
        local -a cmd_args=("docker" "compose" "-f" "$compose_file")
        if [ -f "$env_file" ]; then
            cmd_args+=("--env-file" "$env_file")
        fi
        
        "${cmd_args[@]}" ps
    else
        # Show status for all modules
        info "Module status overview:"
        echo ""
        
        for mod in media gateway observability homeauto; do
            local compose_file
            compose_file=$(get_compose_file "$mod")
            
            if [ -f "$compose_file" ]; then
                echo "=== $mod ==="
                local env_file
                env_file=$(get_env_file "$mod")
                
                local -a cmd_args=("docker" "compose" "-f" "$compose_file")
                if [ -f "$env_file" ]; then
                    cmd_args+=("--env-file" "$env_file")
                fi
                
                "${cmd_args[@]}" ps 2>/dev/null || echo "  (no containers running)"
                echo ""
            fi
        done
    fi
}

# Module logs command
module_logs() {
    local module="$1"
    local service="${2:-}"
    
    local compose_file
    compose_file=$(get_compose_file "$module")
    check_compose_file "$compose_file"
    
    local env_file
    env_file=$(get_env_file "$module")
    
    local -a cmd_args=("docker" "compose" "-f" "$compose_file")
    if [ -f "$env_file" ]; then
        cmd_args+=("--env-file" "$env_file")
    fi
    
    if [ -n "$service" ]; then
        info "Following logs for $service in $module module..."
        "${cmd_args[@]}" logs -f "$service"
    else
        info "Following logs for $module module..."
        "${cmd_args[@]}" logs -f
    fi
}

# Module restart command
module_restart() {
    local module="$1"
    local service="${2:-}"
    
    local compose_file
    compose_file=$(get_compose_file "$module")
    check_compose_file "$compose_file"
    
    local env_file
    env_file=$(get_env_file "$module")
    
    local -a cmd_args=("docker" "compose" "-f" "$compose_file")
    if [ -f "$env_file" ]; then
        cmd_args+=("--env-file" "$env_file")
    fi
    
    if [ -n "$service" ]; then
        info "Restarting $service in $module module..."
        "${cmd_args[@]}" restart "$service"
        success "$service restarted"
    else
        info "Restarting $module module..."
        "${cmd_args[@]}" restart
        success "$module module restarted"
    fi
}

# Show help
show_help() {
    cat << 'EOF'
orionctl - Orion-Sentinel-CoreSrv Modular Control Script

USAGE:
    ./scripts/orionctl COMMAND [MODULE] [OPTIONS]

MODULES:
    media           Media stack (Jellyfin, *arr, qBittorrent, etc.)
    gateway         Gateway stack (Traefik reverse proxy)
    observability   Monitoring stack (Prometheus, Grafana, Loki, etc.)
    homeauto        Home automation (Home Assistant, Zigbee2MQTT, Mealie, etc.)

COMMANDS:
    up MODULE [PROFILE]     Start a module (optional profile: media-core, media-vpn, zigbee)
    down MODULE             Stop a module
    status [MODULE]         Show status (all modules if none specified)
    logs MODULE [SERVICE]   Follow logs for a module or specific service
    restart MODULE [SVC]    Restart a module or specific service
    doctor                  Check for common issues (file vs directory, missing configs)

EXAMPLES:
    # Start media stack (without VPN)
    ./scripts/orionctl up media

    # Start media stack with VPN
    ./scripts/orionctl up media media-vpn

    # Stop media stack
    ./scripts/orionctl down media

    # View status of all modules
    ./scripts/orionctl status

    # View logs for Jellyfin
    ./scripts/orionctl logs media jellyfin

    # Restart Sonarr
    ./scripts/orionctl restart media sonarr

    # Start gateway (Traefik reverse proxy)
    ./scripts/orionctl up gateway

    # Start observability (Prometheus + Grafana)
    ./scripts/orionctl up observability

    # Start home automation (without Zigbee)
    ./scripts/orionctl up homeauto

    # Start home automation WITH Zigbee
    ./scripts/orionctl up homeauto zigbee

    # Run diagnostics
    ./scripts/orionctl doctor

SETUP (before first run):
    1. Run bootstrap:
       ./scripts/bootstrap-coresrv.sh

    2. Review configuration:
       nano .env

    3. Start the gateway first:
       ./scripts/orionctl up gateway

    4. Then start other modules:
       ./scripts/orionctl up homeauto
       ./scripts/orionctl up observability

NOTES:
    - Each module can run independently
    - Media module is the primary, stable module (works without gateway)
    - Gateway module creates the backbone network for reverse proxy
    - Zigbee2MQTT requires profile: ./scripts/orionctl up homeauto zigbee
    - Home Assistant is directly accessible at http://<host-ip>:8123

For legacy monolithic stack, use: ./orionctl.sh
For detailed documentation, see: README.md
EOF
}

# Doctor command - check for common issues
run_doctor() {
    echo ""
    info "Running diagnostics..."
    echo ""
    
    local has_issues=0
    local data_root="${GATEWAY_CONFIG_ROOT:-/srv/orion-sentinel-core/core}"
    local homeauto_root="${HOMEAUTO_CONFIG_ROOT:-/srv/orion-sentinel-core/home-automation}"
    local observability_root="${OBSERVABILITY_CONFIG_ROOT:-/srv/orion-sentinel-core/monitoring}"
    
    # Try to read from env files for correct paths
    if [ -f "$ENV_DIR/.env.gateway" ]; then
        # shellcheck disable=SC1091
        source "$ENV_DIR/.env.gateway" 2>/dev/null || true
        data_root="${GATEWAY_CONFIG_ROOT:-$data_root}"
    fi
    if [ -f "$ENV_DIR/.env.homeauto" ]; then
        # shellcheck disable=SC1091
        source "$ENV_DIR/.env.homeauto" 2>/dev/null || true
        homeauto_root="${HOMEAUTO_CONFIG_ROOT:-$homeauto_root}"
    fi
    if [ -f "$ENV_DIR/.env.observability" ]; then
        # shellcheck disable=SC1091
        source "$ENV_DIR/.env.observability" 2>/dev/null || true
        observability_root="${OBSERVABILITY_CONFIG_ROOT:-$observability_root}"
    fi
    
    echo "=== Checking required FILES (must NOT be directories) ==="
    
    # Check Traefik config file
    local traefik_yml="${data_root}/traefik/traefik.yml"
    if [ -d "$traefik_yml" ]; then
        error "CRITICAL: $traefik_yml is a DIRECTORY but should be a FILE"
        echo "  Fix: sudo rm -rf $traefik_yml && cp core/traefik/traefik.yml $traefik_yml"
        has_issues=1
    elif [ -f "$traefik_yml" ]; then
        success "OK: $traefik_yml exists as a file"
    else
        warn "MISSING: $traefik_yml (will be created on bootstrap)"
    fi
    
    # Check Mosquitto config file
    local mosquitto_conf="${homeauto_root}/mosquitto/mosquitto.conf"
    if [ -d "$mosquitto_conf" ]; then
        error "CRITICAL: $mosquitto_conf is a DIRECTORY but should be a FILE"
        echo "  Fix: sudo rm -rf $mosquitto_conf && cp home-automation/mosquitto/mosquitto.conf.example $mosquitto_conf"
        has_issues=1
    elif [ -f "$mosquitto_conf" ]; then
        success "OK: $mosquitto_conf exists as a file"
    else
        warn "MISSING: $mosquitto_conf (will be created on bootstrap)"
    fi
    
    # Check Prometheus config file
    local prometheus_yml="${observability_root}/prometheus/prometheus.yml"
    if [ -d "$prometheus_yml" ]; then
        error "CRITICAL: $prometheus_yml is a DIRECTORY but should be a FILE"
        echo "  Fix: sudo rm -rf $prometheus_yml && cp monitoring/prometheus/prometheus.yml $prometheus_yml"
        has_issues=1
    elif [ -f "$prometheus_yml" ]; then
        success "OK: $prometheus_yml exists as a file"
    else
        warn "MISSING: $prometheus_yml (will be created on bootstrap)"
    fi
    
    echo ""
    echo "=== Checking required DIRECTORIES ==="
    
    # Check Traefik dynamic config directory
    local traefik_dynamic="${data_root}/traefik/dynamic"
    if [ -f "$traefik_dynamic" ]; then
        error "CRITICAL: $traefik_dynamic is a FILE but should be a DIRECTORY"
        has_issues=1
    elif [ -d "$traefik_dynamic" ]; then
        success "OK: $traefik_dynamic exists as a directory"
    else
        warn "MISSING: $traefik_dynamic"
    fi
    
    echo ""
    echo "=== Checking Docker networks ==="
    
    for net in orion_backbone_net orion_gateway_net orion_homeauto_net orion_observability_net orion_media_net; do
        if docker network inspect "$net" >/dev/null 2>&1; then
            success "OK: Network $net exists"
        else
            warn "MISSING: Network $net (will be created by bootstrap)"
        fi
    done
    
    echo ""
    echo "=== Checking Zigbee device (optional) ==="
    
    local zigbee_device="${ZIGBEE_DEVICE:-/dev/ttyACM0}"
    if [ -e "$zigbee_device" ]; then
        success "OK: Zigbee device $zigbee_device found"
    else
        warn "NOT FOUND: Zigbee device $zigbee_device"
        echo "  Zigbee2MQTT requires a USB coordinator. If not using Zigbee, this is OK."
        echo "  Start homeauto without zigbee profile: ./scripts/orionctl up homeauto"
    fi
    
    echo ""
    if [ $has_issues -eq 1 ]; then
        error "Issues found! Run ./scripts/bootstrap-coresrv.sh to fix."
        return 1
    else
        success "All checks passed!"
        return 0
    fi
}

# Main command handling
CMD=${1:-}
MODULE=${2:-}
ARG3=${3:-}

case "$CMD" in
    up)
        if [ -z "$MODULE" ]; then
            error "Usage: ./scripts/orionctl up MODULE [PROFILE]"
        fi
        module_up "$MODULE" "$ARG3"
        ;;
    
    down)
        if [ -z "$MODULE" ]; then
            error "Usage: ./scripts/orionctl down MODULE"
        fi
        module_down "$MODULE"
        ;;
    
    status)
        module_status "$MODULE"
        ;;
    
    logs)
        if [ -z "$MODULE" ]; then
            error "Usage: ./scripts/orionctl logs MODULE [SERVICE]"
        fi
        module_logs "$MODULE" "$ARG3"
        ;;
    
    restart)
        if [ -z "$MODULE" ]; then
            error "Usage: ./scripts/orionctl restart MODULE [SERVICE]"
        fi
        module_restart "$MODULE" "$ARG3"
        ;;
    
    help|--help|-h|"")
        show_help
        ;;
    
    doctor)
        run_doctor
        ;;
    
    *)
        error "Unknown command: $CMD\nUse './scripts/orionctl help' for usage"
        ;;
esac
