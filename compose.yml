# Orion-Sentinel-CoreSrv main compose file
# Profiles:
#   core          -> Traefik + Authelia
#   media-core    -> Jellyfin + *arr + qBittorrent + VPN + Jellyseerr + Prowlarr + Bazarr
#   media-ai      -> Recommendarr
#   maintenance   -> Homepage + Watchtower + Autoheal (and later cleanuparr/decluttarr)

services:
  ############################
  # CORE: Reverse proxy + SSO
  ############################

  traefik:
    image: traefik:v3.0
    container_name: traefik
    profiles: ["core"]
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      # ACME/DNS-01 can be added later:
      # - --certificatesresolvers.le.acme.email=${TRAEFIK_ACME_EMAIL}
      # - --certificatesresolvers.le.acme.storage=/acme/acme.json
      # - --certificatesresolvers.le.acme.dnschallenge=true
      # - --certificatesresolvers.le.acme.dnschallenge.provider=${TRAEFIK_ACME_DNS_PROVIDER}
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONFIG_ROOT}/traefik:/etc/traefik
      - ${CONFIG_ROOT}/traefik/acme:/acme
    networks:
      - orion_proxy
      - orion_internal
    labels:
      # Optional: expose Traefik dashboard via SSO later
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.local`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      # Add Authelia middleware once Authelia is running
      # - "traefik.http.routers.traefik.middlewares=authelia@docker"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    profiles: ["core"]
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      # These should come from env/.env.core (real values)
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET:-changeme}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET:-changeme}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY:-changeme}
    volumes:
      - ${CONFIG_ROOT}/authelia:/config
    networks:
      - orion_proxy
      - orion_internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.local`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.routers.authelia.tls=true"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      # Authelia ForwardAuth middleware
      - "traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/verify?rd=https%3A%2F%2Fauth.local%2F"
      - "traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"

  ############################################
  # MEDIA-CORE: media apps + qBit + VPN
  ############################################

  vpn:
    image: ${VPN_IMAGE:-qmcgaw/gluetun:latest}
    container_name: vpn
    profiles: ["media-core"]
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    environment:
      - TZ=${TZ}
      # ProtonVPN / Gluetun-specific envs, placeholders in env/.env.media
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${VPN_WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${VPN_WIREGUARD_ADDRESS}
      - VPN_ENDPOINT_PORT=51820
      - SERVER_COUNTRIES=${VPN_COUNTRY}
      - FIREWALL=on
      - LOG_LEVEL=info
      - DOT=off
      - UPDATER_PERIOD=24h
      - HTTPPROXY=off
      - SHADOWSOCKS=off
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - orion_vpn
      - orion_internal
    # Expose qBittorrent WebUI via this container
    ports:
      - "8080:8080"  # qBittorrent WebUI via VPN
    labels:
      # Route qBittorrent UI through Traefik via VPN container
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent.rule=Host(`qbit.local`)"
      - "traefik.http.routers.qbittorrent.entrypoints=websecure"
      - "traefik.http.routers.qbittorrent.tls=true"
      - "traefik.http.routers.qbittorrent.middlewares=authelia@docker"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:4.6.7
    container_name: qbittorrent
    profiles: ["media-core"]
    restart: unless-stopped
    network_mode: "service:vpn"  # share network namespace with vpn
    depends_on:
      - vpn
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=${QBITTORRENT_WEBUI_PORT:-8080}
    volumes:
      - ${CONFIG_ROOT}/qbittorrent:/config
      - ${DOWNLOAD_ROOT}:/downloads

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:10.9.11
    container_name: jellyfin
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/jellyfin:/config
      - ${MEDIA_LIBRARY_ROOT}:/media:ro
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`${JELLYFIN_HOST:-jellyfin.local}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      # Optionally protect with Authelia, or split admin vs user routes later
      # - "traefik.http.routers.jellyfin.middlewares=authelia@docker"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"

  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.9
    container_name: sonarr
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/sonarr:/config
      - ${DOWNLOAD_ROOT}:/downloads
      - ${TV_ROOT}:/tv
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.local`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.middlewares=authelia@docker"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  radarr:
    image: lscr.io/linuxserver/radarr:5.9.1
    container_name: radarr
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/radarr:/config
      - ${DOWNLOAD_ROOT}:/downloads
      - ${MOVIES_ROOT}:/movies
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.local`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.middlewares=authelia@docker"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  bazarr:
    image: lscr.io/linuxserver/bazarr:1.4.5
    container_name: bazarr
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/bazarr:/config
      - ${MEDIA_LIBRARY_ROOT}:/media
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.local`)"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.tls=true"
      - "traefik.http.routers.bazarr.middlewares=authelia@docker"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:1.21.2
    container_name: prowlarr
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/prowlarr:/config
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`${PROWLARR_HOST:-prowlarr.local}`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.middlewares=authelia@docker"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  jellyseerr:
    image: fallenbagel/jellyseerr:1.8.0
    container_name: jellyseerr
    profiles: ["media-core"]
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/jellyseerr:/app/config
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`${JELLYSEERR_HOST:-requests.local}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=websecure"
      - "traefik.http.routers.jellyseerr.tls=true"
      - "traefik.http.routers.jellyseerr.middlewares=authelia@docker"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"

  ##########################################
  # MEDIA-AI: Recommendarr
  ##########################################

  recommendarr:
    image: ghcr.io/ludeeus/recommendarr:latest
    container_name: recommendarr
    profiles: ["media-ai"]
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - SONARR_URL=${SONARR_BASE_URL}
      - SONARR_API_KEY=${SONARR_API_KEY}
      - RADARR_URL=${RADARR_BASE_URL}
      - RADARR_API_KEY=${RADARR_API_KEY}
      - JELLYFIN_URL=${JELLYFIN_BASE_URL}
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY}
      - TRAKT_CLIENT_ID=${TRAKT_CLIENT_ID}
      - TRAKT_CLIENT_SECRET=${TRAKT_CLIENT_SECRET}
      - TRAKT_ACCESS_TOKEN=${TRAKT_ACCESS_TOKEN}
    volumes:
      - ${CONFIG_ROOT}/recommendarr:/config
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.recommendarr.rule=Host(`${RECOMMENDARR_HOST:-recommend.local}`)"
      - "traefik.http.routers.recommendarr.entrypoints=websecure"
      - "traefik.http.routers.recommendarr.tls=true"
      - "traefik.http.routers.recommendarr.middlewares=authelia@docker"
      - "traefik.http.services.recommendarr.loadbalancer.server.port=8000"

  ##########################################
  # MAINTENANCE: homepage + watchtower + autoheal
  ##########################################

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    profiles: ["maintenance"]
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - orion_internal
      - orion_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`home.local`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.routers.homepage.middlewares=authelia@docker"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

  watchtower:
    image: containrrr/watchtower:1.7.1
    container_name: watchtower
    profiles: ["maintenance"]
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true
      # Start with notifications off
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  autoheal:
    image: willfarrell/autoheal:1.2.0
    container_name: autoheal
    profiles: ["maintenance"]
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

############################
# NETWORKS
############################

networks:
  orion_proxy:
    name: orion_proxy
  orion_internal:
    name: orion_internal
  orion_vpn:
    name: orion_vpn
  orion_monitoring:
    name: orion_monitoring
