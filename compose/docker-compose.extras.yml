# Orion-Sentinel-CoreSrv Extras Module
# Homepage Dashboard + SearXNG Search + Watchtower (optional)
#
# This module provides additional utility services:
#   - Homepage: Unified dashboard for all services
#   - SearXNG: Privacy-respecting metasearch engine
#   - Watchtower: Container auto-update (optional, disabled by default)
#
# Usage:
#   make up-extras
#
# Direct docker compose:
#   docker compose -f compose/docker-compose.extras.yml up -d
#
# Ports:
#   3003 - Homepage dashboard (via Traefik: homepage.local)
#   8888 - SearXNG (via Traefik: search.local)

services:
  ############################
  # HOMEPAGE: Dashboard
  ############################

  homepage:
    image: ghcr.io/gethomepage/homepage:v0.8.8
    container_name: orion_homepage
    restart: unless-stopped
    networks:
      - orion_backbone_net
      - orion_proxy_net
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ${MAINTENANCE_ROOT:-/srv/orion-sentinel-core/maintenance}/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "3003:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN:-local}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  ############################
  # SEARXNG: Privacy Search
  ############################

  searxng:
    # Using commit hash tag format as per SearXNG stable release tagging
    # This specific version (2024.1.28) with commit b5c7b0c88 is a tested stable release
    image: searxng/searxng:2024.1.28-b5c7b0c88
    container_name: orion_searxng
    restart: unless-stopped
    networks:
      - orion_backbone_net
      - orion_proxy_net
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - SEARXNG_BASE_URL=https://search.${DOMAIN:-local}
    volumes:
      - ${SEARCH_ROOT:-/srv/orion-sentinel-core/search}/searxng:/etc/searxng:rw
    ports:
      - "8888:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.searxng.rule=Host(`search.${DOMAIN:-local}`)"
      - "traefik.http.routers.searxng.entrypoints=websecure"
      - "traefik.http.routers.searxng.tls=true"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  ############################
  # WATCHTOWER: Auto-Update (DISABLED BY DEFAULT)
  ############################
  # Uncomment to enable automatic container updates
  # WARNING: Can cause breaking changes! Use with caution.
  #
  # watchtower:
  #   image: containrrr/watchtower:1.7.1
  #   container_name: orion_watchtower
  #   restart: unless-stopped
  #   networks:
  #     - orion_backbone_net
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   environment:
  #     - TZ=${TZ:-UTC}
  #     - WATCHTOWER_CLEANUP=true
  #     - WATCHTOWER_INCLUDE_STOPPED=false
  #     - WATCHTOWER_SCHEDULE=0 0 4 * * *  # 4 AM daily
  #     - WATCHTOWER_NOTIFICATIONS=email
  #     - WATCHTOWER_NOTIFICATION_EMAIL_FROM=${WATCHTOWER_EMAIL_FROM}
  #     - WATCHTOWER_NOTIFICATION_EMAIL_TO=${WATCHTOWER_EMAIL_TO}
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=${WATCHTOWER_EMAIL_SERVER}
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=${WATCHTOWER_EMAIL_PORT:-587}
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${WATCHTOWER_EMAIL_USER}
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${WATCHTOWER_EMAIL_PASSWORD}
  #   labels:
  #     - "traefik.enable=false"

############################
# NETWORKS
############################

networks:
  orion_backbone_net:
    name: orion_backbone_net
    external: true
  
  orion_proxy_net:
    name: orion_proxy_net
    external: true
