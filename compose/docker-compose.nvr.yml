# Orion-Sentinel-CoreSrv NVR Module (Frigate)
# Network Video Recorder for RTSP cameras (Tapo C220/C210, etc.)
#
# This module provides video recording and object detection:
#   - Frigate NVR: Recording, detection, events, and live view
#
# Usage:
#   ./scripts/orionctl up nvr
#
# Direct docker compose:
#   docker compose -f compose/docker-compose.nvr.yml up -d
#
# Prerequisites:
#   1. Create Frigate config: cp config/frigate/config.example.yml config/frigate/config.yml
#   2. Edit config/frigate/config.yml with your camera IPs and credentials
#   3. Set ORION_CCTV_MEDIA_DIR in .env to a path with sufficient storage
#
# Ports:
#   5000 - Frigate WebUI
#   8554 - RTSP restream
#   8555 - WebRTC
#
# Hardware acceleration (optional):
#   - Intel QSV: Uncomment the devices section for /dev/dri
#   - Coral TPU: Uncomment the devices section for USB Coral
#
# Storage recommendation:
#   Mount a large SSD at ${ORION_CCTV_MEDIA_DIR} (default: /mnt/orion-cctv)
#   1TB+ recommended for multi-camera 24/7 recording

services:
  ############################
  # FRIGATE: Network Video Recorder
  ############################

  orion-frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: orion_frigate
    restart: unless-stopped
    # shm_size is used for frame buffer; increase if you have many high-res cameras
    # 64mb per camera is a good baseline, 256mb should handle 3-4 1080p cameras
    shm_size: ${FRIGATE_SHM_SIZE:-256mb}
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      # MQTT configuration (optional - Frigate works without MQTT)
      - FRIGATE_MQTT_HOST=${FRIGATE_MQTT_HOST:-}
      - FRIGATE_MQTT_USER=${FRIGATE_MQTT_USER:-}
      - FRIGATE_MQTT_PASSWORD=${FRIGATE_MQTT_PASSWORD:-}
      # Internal RTSP password for restream authentication (optional)
      - FRIGATE_RTSP_PASSWORD=${FRIGATE_RTSP_PASSWORD:-}
    volumes:
      # Frigate configuration (required)
      - ${NVR_CONFIG_ROOT:-./config/frigate}:/config
      # Recordings and clips storage (should be on large SSD)
      - ${ORION_CCTV_MEDIA_DIR:-/mnt/orion-cctv}:/media/frigate
      # Optional: tmpfs for cache (improves performance, reduces SSD wear)
      # Uncomment if you want to use tmpfs for cache:
      # - type: tmpfs
      #   target: /tmp/cache
      #   tmpfs:
      #     size: 1000000000  # 1GB
    ports:
      # WebUI
      - "5000:5000"
      # RTSP restream feeds
      - "8554:8554"
      # WebRTC
      - "8555:8555/tcp"
      - "8555:8555/udp"
    networks:
      - orion_nvr_net
      - orion_proxy
    security_opt:
      - no-new-privileges:true
    # Hardware acceleration for Intel QSV (uncomment if you have Intel GPU)
    # devices:
    #   - /dev/dri:/dev/dri
    # Hardware acceleration for Coral TPU (uncomment if you have USB Coral)
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb
    # For PCIe/M.2 Coral:
    # devices:
    #   - /dev/apex_0:/dev/apex_0
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5000/api/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      # Traefik labels for reverse proxy (requires gateway module)
      - "traefik.enable=true"
      - "traefik.http.routers.frigate.rule=Host(`frigate.${LOCAL_DOMAIN:-orion.lan}`)"
      - "traefik.http.routers.frigate.entrypoints=websecure"
      - "traefik.http.routers.frigate.tls=true"
      - "traefik.http.routers.frigate.middlewares=security-headers@file"
      - "traefik.http.services.frigate.loadbalancer.server.port=5000"
      # Promtail/Loki log collection labels (for observability integration)
      - "orion.stack=nvr"
      - "orion.service=frigate"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

############################
# NETWORKS
############################

networks:
  orion_nvr_net:
    name: orion_nvr_net
    driver: bridge
  # Proxy network for Traefik routing (external)
  orion_proxy:
    name: orion_proxy
    external: true
