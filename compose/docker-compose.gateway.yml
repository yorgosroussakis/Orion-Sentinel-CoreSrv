# Orion-Sentinel-CoreSrv Gateway Module
# Traefik for reverse proxy
#
# This module provides:
#   - Traefik v3: Reverse proxy with automatic HTTPS
#
# Usage:
#   ./scripts/orionctl up gateway
#
# Direct docker compose:
#   docker compose -f compose/docker-compose.gateway.yml up -d
#
# Integration with other modules:
#   - Other modules can join orion_backbone_net to get reverse proxy access
#   - Add Traefik labels to services to expose them via gateway
#
# Ports:
#   80   - HTTP (redirects to HTTPS)
#   443  - HTTPS
#   8080 - Traefik dashboard (internal only)

services:
  ############################
  # TRAEFIK: Reverse Proxy
  ############################

  traefik:
    image: traefik:v3.2
    container_name: orion_traefik
    restart: unless-stopped
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${GATEWAY_CONFIG_ROOT:-/srv/orion-sentinel-core/core}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ${GATEWAY_CONFIG_ROOT:-/srv/orion-sentinel-core/core}/traefik/dynamic:/etc/traefik/dynamic:ro
      - ${GATEWAY_CONFIG_ROOT:-/srv/orion-sentinel-core/core}/traefik/acme:/acme
    networks:
      - orion_gateway_net
      - orion_backbone_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN:-orion.lan}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD-SHELL", "traefik healthcheck --ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s


############################
# NETWORKS
############################

networks:
  orion_gateway_net:
    name: orion_gateway_net
    external: true
  # Backbone network for cross-module communication
  # Other modules can attach to this to get reverse proxy access
  orion_backbone_net:
    name: orion_backbone_net
    external: true
